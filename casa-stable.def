BootStrap: debootstrap
MirrorURL: http://archive.ubuntu.com/ubuntu/
OSVersion: bionic
Include: software-properties-common

%environment
	export LC_ALL=C
	export PATH=$PATH:/opt/casa-pipeline-release-5.6.2-2.el7/bin/

%post
	apt-get update -y
	apt-get install -y wget vim apt-utils git
	apt-add-repository multiverse
	apt-add-repository restricted
	add-apt-repository -s ppa:kernsuite/kern-5
	apt-get update -y

	apt-get install -y tzdata
	apt-get install -y libxrandr-dev libxcursor-dev libxinerama-dev libfontconfig1-dev fontconfig libxft-dev libgl1 libsm-dev libx11-dev libxext-dev libxi-dev libxrender-dev libxml2 libxslt1.1 libapparmor1 libtcl8.6 dbus dbus-x11 libtk8.6 tk8.6-blt2.5 blt python-tk ghostscript xvfb

	apt-get install -y casacore-dev casacore-doc python-casacore python3-casacore pybdsf

	mkdir -p /opt
	wget -O - https://casa.nrao.edu/download/distro/casa-pipeline/release/el7/casa-pipeline-release-5.6.2-2.el7.tar.gz | tar xz
	mv casa-pipeline-release-5.6.2-2.el7 /opt/
	
	# Update the Config file to log to memory only.
	sed -i 's/__configs.HistoryManager.hist_file.*/__configs.HistoryManager.hist_file=":memory:"/g' /opt/casa-pipeline-release-5.6.2-2.el7/lib/python2.7/start_casa.py
	sed -i "68i\ \ \ \ __configs.HistoryManager.enabled=False" /opt/casa-pipeline-release-5.6.2-2.el7/lib/python2.7/start_casa.py

	# Install virtualenv
	apt-get install -y virtualenv

	# Cleanup the container
	apt-get clean
	apt-get autoclean

%runscript
	/opt/casa-pipeline-release-5.6.2-2.el7/bin/python "$@"
